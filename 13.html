<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ˜Ÿé™…è¯¾å ‚ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        body {
            margin: 0;
            padding: 20px;
            background: #0a0f2b;
            color: #fff;
            font-family: 'Orbitron', sans-serif;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 0, 50, 0.9);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 0 50px rgba(0, 191, 255, 0.3);
            border: 2px solid #00bfff;
            position: relative;
            z-index: 1;
        }

        h1 {
            text-align: center;
            color: #00f7ff;
            text-shadow: 0 0 10px #00f7ff;
            font-size: 2.5em;
            margin: 20px 0;
            letter-spacing: 3px;
        }

        .toolbar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .space-btn {
            background: linear-gradient(45deg, #001d3d, #003566);
            border: 1px solid #00bfff;
            color: #00f7ff;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 5px rgba(0, 247, 255, 0.5);
        }

        .space-btn:hover {
            background: linear-gradient(45deg, #003566, #001d3d);
            box-shadow: 0 0 15px #00bfff;
            transform: translateY(-2px);
        }

        .classroom-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 30px 0;
        }

        .platform {
            background: rgba(0, 63, 127, 0.8);
            border: 2px solid #00bfff;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            position: relative;
            width: 300px;
        }

        .platform:after {
            content: 'è®²å°';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: #0a0f2b;
            color: #00f7ff;
            padding: 0 15px;
            font-size: 1.2em;
        }

        .seat-map-container {
            width: 100%;
            overflow-x: auto;
            padding: 10px 0;
        }

        .seat-map {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 1000px;
        }

        .seat-row {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .student-seat {
            padding: 15px 10px;
            border: 1px solid #00bfff;
            border-radius: 8px;
            background: rgba(0, 31, 63, 0.8);
            color: #00f7ff;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            width: 120px;
            min-width: 120px;
            box-sizing: border-box;
        }

        .student-seat.empty {
            visibility: hidden;
            pointer-events: none;
        }

        .student-seat:hover {
            background: rgba(0, 63, 127, 0.8);
            box-shadow: 0 0 15px #00bfff;
        }

        .student-seat.reported {
            background: linear-gradient(45deg, #6a0000, #8b0000);
            animation: alert 1s infinite alternate;
        }

        .student-seat.praised {
            background: linear-gradient(45deg, #006a00, #008b00);
            animation: praise 1s infinite alternate;
        }

        .student-seat.called {
            background: linear-gradient(45deg, #6a006a, #8b008b);
            animation: called 1s infinite alternate;
        }

        .student-seat.draggable {
            cursor: move;
        }

        .student-seat.dragging {
            opacity: 0.8;
            transform: scale(1.05);
            z-index: 100;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 15, 30, 0.95);
            border: 2px solid #00bfff;
            border-radius: 15px;
            padding: 30px;
            z-index: 1000;
            box-shadow: 0 0 50px rgba(0, 191, 255, 0.3);
        }

        .call-modal {
            text-align: center;
            min-width: 300px;
        }

        .called-name {
            font-size: 3em;
            color: #ff0;
            text-shadow: 0 0 20px #ff0;
            margin: 20px 0;
            animation: pulse 1s infinite alternate;
        }

        .pronunciation-hint {
            color: #f80;
            font-size: 1.2em;
            margin-top: 10px;
        }

        select, input {
            background: rgba(0, 31, 63, 0.8);
            border: 1px solid #00bfff;
            color: #00f7ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Orbitron', sans-serif;
            width: 250px;
        }

        @keyframes alert {
            from { box-shadow: 0 0 10px #ff0000; }
            to { box-shadow: 0 0 20px #ff0000; }
        }

        @keyframes praise {
            from { box-shadow: 0 0 10px #00ff00; }
            to { box-shadow: 0 0 20px #00ff00; }
        }

        @keyframes called {
            from { box-shadow: 0 0 10px #ff00ff; }
            to { box-shadow: 0 0 20px #ff00ff; }
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        .stars {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .star {
            position: absolute;
            background: #fff;
            border-radius: 50%;
            animation: twinkle 1.5s infinite alternate;
        }

        @keyframes twinkle {
            from { opacity: 0.3; }
            to { opacity: 1; }
        }

        .export-section {
            margin-top: 20px;
            border-top: 1px solid rgba(0, 191, 255, 0.3);
            padding-top: 15px;
        }

        .record-type {
            margin-bottom: 15px;
        }

        .record-type label {
            margin-right: 15px;
            cursor: pointer;
        }

        .record-type input {
            width: auto;
            margin-right: 5px;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: rgba(0, 31, 63, 0.9);
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            border: 1px solid #00bfff;
        }

        .dropdown-content a {
            color: #00f7ff;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background 0.3s;
        }

        .dropdown-content a:hover {
            background: rgba(0, 63, 127, 0.8);
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .print-seat-map, .print-seat-map * {
                visibility: visible;
            }
            .print-seat-map {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white;
                color: black;
                padding: 20px;
                box-sizing: border-box;
                transform: rotate(0deg);
                transform-origin: 0 0;
            }
            @page {
                size: A4 landscape;
                margin: 10mm;
            }
            .print-platform-container {
                display: flex;
                justify-content: center;
                width: 100%;
                margin-bottom: 20px;
            }
            .print-platform {
                background: #f0f0f0;
                border: 2px solid #333;
                border-radius: 10px;
                padding: 15px;
                text-align: center;
                width: 300px;
                position: relative;
            }
            .print-platform:after {
                content: 'è®²å°';
                position: absolute;
                bottom: -10px;
                left: 50%;
                transform: translateX(-50%);
                background: white;
                color: #333;
                padding: 0 15px;
                font-size: 1.2em;
            }
            .print-seat-map-container {
                width: 100%;
                margin-top: 20px;
            }
            .print-seat-map-rows {
                display: flex;
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }
            .print-seat-row {
                display: flex;
                gap: 10px;
                width: 100%;
            }
            .print-student-seat {
                padding: 10px;
                border: 1px solid #333;
                border-radius: 5px;
                background: #f9f9f9;
                min-height: 50px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;
                width: 120px;
                min-width: 120px;
                box-sizing: border-box;
                font-size: 14px;
                page-break-inside: avoid;
            }
            .print-title {
                text-align: center;
                font-size: 24px;
                margin-bottom: 20px;
                font-weight: bold;
            }
            .print-date {
                text-align: right;
                margin-bottom: 10px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="stars" id="starContainer"></div>
    
    <div class="container">
        <h1>ğŸª æ˜Ÿé™…è¯¾å ‚ç®¡ç†ç³»ç»Ÿ ğŸš€</h1>
        
        <div class="toolbar">
            <div class="file-input">
                <button class="space-btn" onclick="document.getElementById('importStudents').click()">
                    ğŸ“ å¯¼å…¥åå•
                </button>
                <input type="file" id="importStudents" accept=".csv,.txt" hidden>
            </div>
            <button class="space-btn" onclick="downloadTemplate()">
                ğŸ“¥ ä¸‹è½½æ¨¡æ¿
            </button>
            <button class="space-btn" onclick="exportStatistics()">
                ğŸ“Š å¯¼å‡ºç»Ÿè®¡
            </button>
            <button class="space-btn" onclick="randomCall()" style="background: linear-gradient(45deg, #3d001d, #660033);">
                ğŸ² éšæœºç‚¹å
            </button>
            <button class="space-btn" id="lockSeatsBtn" onclick="toggleSeatLock()">
                ğŸ”“ è§£é”åº§ä½
            </button>
            <div class="dropdown">
                <button class="space-btn">
                    ğŸ”€ æ’åˆ—åº§ä½ â–¼
                </button>
                <div class="dropdown-content">
                    <a href="#" onclick="arrangeSeats('random')">éšæœºå®‰æ’åº§ä½</a>
                    <a href="#" onclick="arrangeSeats('flow')">æŒ‰è§„å¾‹æµåŠ¨æ’åˆ—</a>
                </div>
            </div>
            <button class="space-btn" onclick="printSeatMap()" style="background: linear-gradient(45deg, #1d3d00, #336600);">
                ğŸ–¨ï¸ å¯¼å‡ºåº§ä½è¡¨
            </button>
        </div>

        <div class="classroom-container">
            <div class="platform"></div>
            <div class="seat-map-container">
                <div id="seatMap" class="seat-map"></div>
            </div>
        </div>

        <div id="violationModal" class="modal">
            <h3 style="color: #00f7ff; margin-top: 0">ğŸ“ å­¦ç”Ÿè¡Œä¸ºè®°å½•</h3>
            
            <div class="record-type">
                <label><input type="radio" name="recordType" value="violation" checked> è¿çºªè®°å½•</label>
                <label><input type="radio" name="recordType" value="praise"> è¡¨æ‰¬è®°å½•</label>
            </div>
            
            <div id="violationSection">
                <select id="violationType">
                    <option value="è¯´è¯">ğŸ—£ï¸ è¯´è¯</option>
                    <option value="ç¡è§‰">ğŸ’¤ ç¡è§‰</option>
                    <option value="è¿‡ä½">ğŸš¶ è¿‡ä½</option>
                    <option value="æ‰“æ¶">ğŸ‘Š æ‰“æ¶</option>
                    <option value="éª‚äºº">ğŸ˜  éª‚äºº</option>
                    <option value="åå£æ°´">ğŸ’¦ åå£æ°´</option>
                    <option value="ä¸¢åƒåœ¾">ğŸ—‘ï¸ ä¸¢åƒåœ¾</option>
                    <option value="å…¶ä»–">â“ å…¶ä»–æƒ…å†µ</option>
                </select>
                <input type="text" id="customViolation" placeholder="è¯·è¾“å…¥å…·ä½“å†…å®¹..." 
                       style="display: none; width: 200px">
            </div>
            
            <div id="praiseSection" style="display: none;">
                <select id="praiseType">
                    <option value="ç§¯æå›ç­”é—®é¢˜">ğŸ™‹ ç§¯æå›ç­”é—®é¢˜</option>
                    <option value="æ‹¾é‡‘ä¸æ˜§">ğŸ’° æ‹¾é‡‘ä¸æ˜§</option>
                    <option value="å¸®åŠ©è€å¸ˆåšå¥½äº‹">ğŸ‘¨â€ğŸ« å¸®åŠ©è€å¸ˆåšå¥½äº‹</option>
                    <option value="å¸®åŠ©åŒå­¦åšå¥½äº‹">ğŸ‘« å¸®åŠ©åŒå­¦åšå¥½äº‹</option>
                    <option value="ç§¯æåŠ³åŠ¨">ğŸ§¹ ç§¯æåŠ³åŠ¨</option>
                    <option value="å…¶ä»–å¥½è¡Œä¸º">ğŸŒŸ å…¶ä»–å¥½è¡Œä¸º</option>
                </select>
                <input type="text" id="customPraise" placeholder="è¯·è¾“å…¥å…·ä½“å†…å®¹..." 
                       style="display: none; width: 200px">
            </div>

            <div class="export-section">
                <button class="space-btn" onclick="exportCurrentStudentRecords()" 
                        style="width: 100%; margin: 10px 0">
                    ğŸ“„ å¯¼å‡ºå½“å‰å­¦ç”Ÿæ¡£æ¡ˆ
                </button>
            </div>

            <div style="margin-top: 20px">
                <button class="space-btn" onclick="recordBehavior()">âœ… ç¡®è®¤è®°å½•</button>
                <button class="space-btn" onclick="closeModal()">âŒ å–æ¶ˆ</button>
            </div>
        </div>

        <div id="callModal" class="modal call-modal" style="display: none;">
            <h3 style="color: #00f7ff; margin-top: 0">ğŸ² éšæœºç‚¹åç»“æœ</h3>
            <div class="called-name" id="calledStudent"></div>
            <div class="pronunciation-hint" id="pronunciationHint" style="display: none;">
                æ³¨æ„ï¼š"è¦ƒ"å­—çš„æ­£ç¡®å‘éŸ³æ˜¯"qÃ­n"ï¼Œä¸æ˜¯"tÃ¡n"
            </div>
            <button class="space-btn" onclick="closeCallModal()" style="margin-top: 20px;">
                ç¡®å®š
            </button>
        </div>

        <div id="printSeatMap" class="print-seat-map" style="display: none;">
            <div class="print-title" id="printTitle">ç­çº§åº§ä½è¡¨</div>
            <div class="print-date" id="printDate"></div>
            <div class="print-platform-container">
                <div class="print-platform"></div>
            </div>
            <div class="print-seat-map-container">
                <div class="print-seat-map-rows" id="printSeatMapRows"></div>
            </div>
        </div>
    </div>

    <script>
        // æ•°æ®å­˜å‚¨
        let students = JSON.parse(localStorage.getItem('students')) || [];
        let currentStudent = null;
        let violations = JSON.parse(localStorage.getItem('violations')) || {};
        let praises = JSON.parse(localStorage.getItem('praises')) || {};
        let calledStudents = JSON.parse(localStorage.getItem('calledStudents')) || [];
        let availableStudents = [];
        let seatMap = JSON.parse(localStorage.getItem('seatMap')) || [];
        let isSeatLocked = true;
        let draggedSeat = null;
        let currentFileName = 'ç­çº§ç®¡ç†æƒ…å†µæ±‡æ€»è¡¨';

        // å›ºå®šåº§ä½å¸ƒå±€ - 7è¡Œ8åˆ—å…±56ä¸ªåº§ä½
        const TOTAL_SEATS = 56;
        const SEATS_PER_ROW = 8;
        const TOTAL_ROWS = 7;

        // åˆå§‹åŒ–åº§ä½å›¾
        function initializeSeatMap() {
            if (seatMap.length > 0 && seatMap.flat().filter(s => s).length > 0) {
                renderSeatMap();
                return;
            }
            
            seatMap = [];
            let studentIndex = 0;
            
            for (let row = 0; row < TOTAL_ROWS; row++) {
                const rowSeats = [];
                for (let col = 0; col < SEATS_PER_ROW; col++) {
                    if (studentIndex < students.length) {
                        rowSeats.push(students[studentIndex]);
                        studentIndex++;
                    } else {
                        rowSeats.push(null);
                    }
                }
                seatMap.push(rowSeats);
            }
            
            localStorage.setItem('seatMap', JSON.stringify(seatMap));
            renderSeatMap();
        }

        // æ¸²æŸ“åº§ä½å›¾
        function renderSeatMap() {
            const seatMapElement = document.getElementById('seatMap');
            seatMapElement.innerHTML = '';
            
            seatMap.forEach((row, rowIndex) => {
                if (!row.some(student => student)) return;
                
                const rowElement = document.createElement('div');
                rowElement.className = 'seat-row';
                
                row.forEach((student, colIndex) => {
                    const seatElement = document.createElement('div');
                    seatElement.className = 'student-seat';
                    seatElement.dataset.row = rowIndex;
                    seatElement.dataset.col = colIndex;
                    
                    if (!student) {
                        seatElement.classList.add('empty');
                        rowElement.appendChild(seatElement);
                        return;
                    }
                    
                    const violationCount = violations[student]?.length || 0;
                    const praiseCount = praises[student]?.length || 0;
                    const isCalled = calledStudents.includes(student);
                    
                    if (isCalled) {
                        seatElement.classList.add('called');
                    } else if (violationCount > 0 && praiseCount > 0) {
                        seatElement.style.background = 'linear-gradient(135deg, #6a0000 50%, #006a00 50%)';
                    } else if (violationCount > 0) {
                        seatElement.classList.add('reported');
                    } else if (praiseCount > 0) {
                        seatElement.classList.add('praised');
                    }
                    
                    seatElement.innerHTML = `
                        <div>${student}</div>
                        ${violationCount > 0 ? 
                        `<div style="font-size:0.8em;color:#ff4444;margin-top:5px">
                            ğŸš«${violationCount}æ¬¡
                        </div>` : ''}
                        ${praiseCount > 0 ? 
                        `<div style="font-size:0.8em;color:#44ff44;margin-top:5px">
                            ğŸ‘${praiseCount}æ¬¡
                        </div>` : ''}
                        ${isCalled ? 
                        `<div style="font-size:0.8em;color:#ff44ff;margin-top:5px">
                            âœ…å·²ç‚¹å
                        </div>` : ''}
                    `;
                    
                    seatElement.onclick = (e) => {
                        if (isSeatLocked && student) {
                            openRecordModal(student);
                        }
                    };
                    
                    if (!isSeatLocked) {
                        seatElement.classList.add('draggable');
                        seatElement.draggable = true;
                        
                        seatElement.addEventListener('dragstart', (e) => {
                            draggedSeat = { row: rowIndex, col: colIndex, student };
                            e.dataTransfer.setData('text/plain', '');
                            setTimeout(() => {
                                seatElement.classList.add('dragging');
                            }, 0);
                        });
                        
                        seatElement.addEventListener('dragend', () => {
                            seatElement.classList.remove('dragging');
                        });
                    }
                    
                    seatElement.addEventListener('dragover', (e) => {
                        if (!isSeatLocked && draggedSeat) {
                            e.preventDefault();
                        }
                    });
                    
                    seatElement.addEventListener('drop', (e) => {
                        if (!isSeatLocked && draggedSeat) {
                            e.preventDefault();
                            
                            const targetRow = parseInt(seatElement.dataset.row);
                            const targetCol = parseInt(seatElement.dataset.col);
                            
                            // äº¤æ¢ä¸¤ä¸ªåº§ä½çš„å­¦ç”Ÿ
                            const temp = seatMap[targetRow][targetCol];
                            seatMap[targetRow][targetCol] = draggedSeat.student;
                            seatMap[draggedSeat.row][draggedSeat.col] = temp;
                            
                            localStorage.setItem('seatMap', JSON.stringify(seatMap));
                            renderSeatMap();
                            
                            draggedSeat = null;
                        }
                    });
                    
                    rowElement.appendChild(seatElement);
                });
                
                seatMapElement.appendChild(rowElement);
            });
        }

        // æ‰“å°åº§ä½è¡¨
        function printSeatMap() {
            const printElement = document.getElementById('printSeatMap');
            const printRows = document.getElementById('printSeatMapRows');
            const printDate = document.getElementById('printDate');
            const printTitle = document.getElementById('printTitle');
            
            const today = new Date();
            printDate.textContent = `æ—¥æœŸ: ${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
            // ä¿®æ”¹åº§ä½è¡¨åç§°ï¼Œä½¿ç”¨å¯¼å…¥çš„æ–‡ä»¶å
            printTitle.textContent = currentFileName.replace('.csv', '').replace('.txt', '') + 'åº§ä½è¡¨';
            
            printRows.innerHTML = '';
            
            seatMap.forEach(row => {
                if (!row.some(student => student)) return;
                
                const rowElement = document.createElement('div');
                rowElement.className = 'print-seat-row';
                
                row.forEach(student => {
                    const seatElement = document.createElement('div');
                    seatElement.className = 'print-student-seat';
                    
                    if (student) {
                        seatElement.textContent = student;
                        const violationCount = violations[student]?.length || 0;
                        const praiseCount = praises[student]?.length || 0;
                        
                        if (violationCount > 0) {
                            seatElement.innerHTML += `<div style="font-size:0.7em;color:#ff0000;margin-top:3px">ğŸš«${violationCount}æ¬¡</div>`;
                        }
                        if (praiseCount > 0) {
                            seatElement.innerHTML += `<div style="font-size:0.7em;color:#00aa00;margin-top:3px">ğŸ‘${praiseCount}æ¬¡</div>`;
                        }
                    } else {
                        seatElement.innerHTML = '&nbsp;';
                    }
                    
                    rowElement.appendChild(seatElement);
                });
                
                printRows.appendChild(rowElement);
            });
            
            printElement.style.display = 'block';
            window.print();
            printElement.style.display = 'none';
        }

        // åˆ‡æ¢åº§ä½é”å®šçŠ¶æ€
        function toggleSeatLock() {
            isSeatLocked = !isSeatLocked;
            document.getElementById('lockSeatsBtn').textContent = 
                isSeatLocked ? 'ğŸ”“ è§£é”åº§ä½' : 'ğŸ”’ é”å®šåº§ä½';
            renderSeatMap();
        }

        // æ’åˆ—åº§ä½
        function arrangeSeats(mode) {
            if (students.length === 0) {
                alert('è¯·å…ˆå¯¼å…¥å­¦ç”Ÿåå•');
                return;
            }
            
            if (mode === 'random') {
                // éšæœºæ’åˆ—
                const allStudents = seatMap.flat().filter(student => student);
                const shuffledStudents = [...allStudents];
                
                // Fisher-Yates æ´—ç‰Œç®—æ³•
                for (let i = shuffledStudents.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffledStudents[i], shuffledStudents[j]] = [shuffledStudents[j], shuffledStudents[i]];
                }
                
                // é‡æ–°å¡«å……åº§ä½
                let studentIndex = 0;
                for (let row = 0; row < seatMap.length; row++) {
                    for (let col = 0; col < seatMap[row].length; col++) {
                        if (seatMap[row][col] !== null) {
                            if (studentIndex < shuffledStudents.length) {
                                seatMap[row][col] = shuffledStudents[studentIndex];
                                studentIndex++;
                            } else {
                                seatMap[row][col] = null;
                            }
                        }
                    }
                }
            } else if (mode === 'flow') {
                // æŒ‰è§„å¾‹æµåŠ¨æ’åˆ—ï¼Œç©ºä½ä¸å‚ä¸æµåŠ¨
                const occupiedSeats = [];
                
                // æ”¶é›†æ‰€æœ‰æœ‰å­¦ç”Ÿçš„åº§ä½
                for (let row = 0; row < seatMap.length; row++) {
                    for (let col = 0; col < seatMap[row].length; col++) {
                        if (seatMap[row][col]) {
                            occupiedSeats.push({
                                row,
                                col,
                                student: seatMap[row][col]
                            });
                        }
                    }
                }
                
                if (occupiedSeats.length === 0) return;
                
                // æµåŠ¨æ’åˆ—ï¼šæ¯ä¸ªå­¦ç”Ÿç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå­¦ç”Ÿçš„ä½ç½®
                const firstStudent = occupiedSeats[0].student;
                
                for (let i = 0; i < occupiedSeats.length - 1; i++) {
                    seatMap[occupiedSeats[i].row][occupiedSeats[i].col] = 
                        seatMap[occupiedSeats[i+1].row][occupiedSeats[i+1].col];
                }
                
                // æœ€åä¸€ä¸ªå­¦ç”Ÿç§»åŠ¨åˆ°ç¬¬ä¸€ä¸ªå­¦ç”Ÿçš„ä½ç½®
                const lastSeat = occupiedSeats[occupiedSeats.length - 1];
                seatMap[lastSeat.row][lastSeat.col] = firstStudent;
            }
            
            localStorage.setItem('seatMap', JSON.stringify(seatMap));
            renderSeatMap();
        }

        // ä¸‹è½½æ¨¡æ¿
        function downloadTemplate() {
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const content = "å­¦ç”Ÿå§“å\nå¼ ä¸‰\næå››\nç‹äº”\nèµµå…­\né™ˆä¸ƒ\nè¦ƒåŒå­¦";
            const blob = new Blob([bom, content], {type: 'text/csv;charset=UTF-8'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'å­¦ç”Ÿåå•æ¨¡æ¿.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // æ–‡ä»¶å¯¼å…¥å¤„ç† - æ”¹è¿›ç¼–ç æ£€æµ‹
        document.getElementById('importStudents').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            currentFileName = file.name;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const buffer = e.target.result;
                    let content = '';
                    
                    // å°è¯•UTF-8è§£ç 
                    try {
                        const decoder = new TextDecoder('utf-8');
                        content = decoder.decode(buffer);
                        
                        // å¤„ç†BOMå¤´
                        if (content.charCodeAt(0) === 0xFEFF) {
                            content = content.substring(1);
                        }
                    } catch (utf8Error) {
                        console.log('UTF-8è§£ç å¤±è´¥ï¼Œå°è¯•GBK');
                        
                        // å¦‚æœUTF-8å¤±è´¥ï¼Œå°è¯•GBK
                        try {
                            // ä½¿ç”¨TextDecoder API (éƒ¨åˆ†æµè§ˆå™¨æ”¯æŒ)
                            if (typeof TextDecoder === 'function') {
                                const decoder = new TextDecoder('gbk');
                                content = decoder.decode(buffer);
                            } else {
                                // å¦‚æœä¸æ”¯æŒTextDecoderï¼Œä½¿ç”¨ç®€å•çš„GBKè½¬UTF-8æ–¹æ¡ˆ
                                // è¿™é‡Œä½¿ç”¨ç®€å•çš„æ›¿æ¢æ–¹æ¡ˆï¼Œå®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„è½¬æ¢
                                const gbkArray = new Uint8Array(buffer);
                                content = gbkArray.reduce((acc, byte) => acc + String.fromCharCode(byte), '');
                            }
                        } catch (gbkError) {
                            console.error('GBKè§£ç å¤±è´¥:', gbkError);
                            alert('æ–‡ä»¶è§£ç å¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶ä½¿ç”¨UTF-8æˆ–GBKç¼–ç ');
                            return;
                        }
                    }
                    
                    // å¤„ç†æ•°æ®
                    students = content.split(/\r?\n/)
                        .map(name => name.trim())
                        .filter((name, index) => name && !(index === 0 && (name === 'å­¦ç”Ÿå§“å' || name === 'å§“å')));
                    
                    if (students.length === 0) {
                        alert('å¯¼å…¥çš„åå•ä¸­æ²¡æœ‰æœ‰æ•ˆå­¦ç”Ÿå§“å');
                        return;
                    }

                    localStorage.setItem('students', JSON.stringify(students));
                    resetCallSystem();
                    seatMap = [];
                    localStorage.setItem('seatMap', JSON.stringify(seatMap));
                    initializeSeatMap();
                    
                    alert(`æˆåŠŸå¯¼å…¥ ${students.length} åå­¦ç”Ÿ`);
                } catch (error) {
                    console.error('å¯¼å…¥é”™è¯¯:', error);
                    alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼å’Œç¼–ç ');
                }
            };
            
            reader.onerror = function() {
                alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
            };
            
            // ä½¿ç”¨readAsArrayBufferè€Œä¸æ˜¯readAsTextï¼Œä»¥ä¾¿æ‰‹åŠ¨å¤„ç†ç¼–ç 
            reader.readAsArrayBuffer(file);
        });

        // è¡Œä¸ºè®°å½•åŠŸèƒ½
        function openRecordModal(student) {
            currentStudent = student;
            document.getElementById('violationModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('violationModal').style.display = 'none';
            document.getElementById('customViolation').style.display = 'none';
            document.getElementById('customViolation').value = '';
            document.getElementById('customPraise').style.display = 'none';
            document.getElementById('customPraise').value = '';
        }

        function recordBehavior() {
            const recordType = document.querySelector('input[name="recordType"]:checked').value;
            
            if (recordType === 'violation') {
                const type = document.getElementById('violationType').value;
                const custom = document.getElementById('customViolation').value;
                const violation = type === 'å…¶ä»–' ? custom : type;
                
                if (!violation) return alert('è¯·è¾“å…¥è¿çºªå†…å®¹');
                
                violations[currentStudent] = violations[currentStudent] || [];
                violations[currentStudent].push({
                    time: new Date().toLocaleString('zh-CN'),
                    type: violation,
                    category: 'violation'
                });
                
                localStorage.setItem('violations', JSON.stringify(violations));
            } else {
                const type = document.getElementById('praiseType').value;
                const custom = document.getElementById('customPraise').value;
                const praise = type === 'å…¶ä»–å¥½è¡Œä¸º' ? custom : type;
                
                if (!praise) return alert('è¯·è¾“å…¥è¡¨æ‰¬å†…å®¹');
                
                praises[currentStudent] = praises[currentStudent] || [];
                praises[currentStudent].push({
                    time: new Date().toLocaleString('zh-CN'),
                    type: praise,
                    category: 'praise'
                });
                
                localStorage.setItem('praises', JSON.stringify(praises));
            }
            
            renderSeatMap();
            closeModal();
        }

        // å¯¼å‡ºå½“å‰å­¦ç”Ÿè¡Œä¸ºæ¡£æ¡ˆ
        function exportCurrentStudentRecords() {
            if (!currentStudent) return alert('è¯·å…ˆé€‰æ‹©å­¦ç”Ÿ');
            
            const violationRecords = violations[currentStudent] || [];
            const praiseRecords = praises[currentStudent] || [];
            
            if (violationRecords.length === 0 && praiseRecords.length === 0) {
                return alert('è¯¥å­¦ç”Ÿæš‚æ— è¡Œä¸ºè®°å½•');
            }

            let content = "\ufeffè®°å½•æ—¶é—´,è®°å½•ç±»å‹,è¡Œä¸ºå†…å®¹\n";
            
            violationRecords.forEach(record => {
                content += `${record.time},è¿çºª,${record.type}\n`;
            });
            
            praiseRecords.forEach(record => {
                content += `${record.time},è¡¨æ‰¬,${record.type}\n`;
            });
            
            downloadFile(`${currentStudent}ä¸ªäººæƒ…å†µè®°å½•.csv`, content);
        }

        // å¯¼å‡ºç»Ÿè®¡ - æ”¹è¿›åçš„ç‰ˆæœ¬ï¼ŒæŒ‰è®°å½•ç±»å‹åˆ†ç±»å¹¶æŒ‰æ¬¡æ•°é™åºæ’åˆ—
        function exportStatistics() {
            // æŒ‰è¿çºªæ¬¡æ•°ç»Ÿè®¡
            const violationStats = Object.entries(violations)
                .map(([student, records]) => ({
                    name: student,
                    type: 'è¿çºª',
                    count: records.length,
                    latest: records[records.length-1]?.time || 'æ— '
                }))
                .sort((a, b) => b.count - a.count);
            
            // æŒ‰è¡¨æ‰¬æ¬¡æ•°ç»Ÿè®¡
            const praiseStats = Object.entries(praises)
                .map(([student, records]) => ({
                    name: student,
                    type: 'è¡¨æ‰¬',
                    count: records.length,
                    latest: records[records.length-1]?.time || 'æ— '
                }))
                .sort((a, b) => b.count - a.count);
            
            let content = "\ufeffå§“å,è®°å½•ç±»å‹,æ¬¡æ•°,æœ€è¿‘è®°å½•æ—¶é—´\n";
            
            // å…ˆè¾“å‡ºè¿çºªè®°å½•
            violationStats.forEach(item => content += `${item.name},${item.type},${item.count},${item.latest}\n`);
            
            // å†è¾“å‡ºè¡¨æ‰¬è®°å½•
            praiseStats.forEach(item => content += `${item.name},${item.type},${item.count},${item.latest}\n`);
            
            downloadFile(`${currentFileName.replace('.csv', '').replace('.txt', '')}ç­çº§ç®¡ç†æƒ…å†µæ±‡æ€»è¡¨.csv`, content);
        }

        // éšæœºç‚¹ååŠŸèƒ½
        function randomCall() {
            if (students.length === 0) {
                return alert('è¯·å…ˆå¯¼å…¥å­¦ç”Ÿåå•');
            }
            
            if (availableStudents.length === 0) {
                resetCallSystem();
            }
            
            const randomIndex = Math.floor(Math.random() * availableStudents.length);
            const selectedStudent = availableStudents[randomIndex];
            
            availableStudents.splice(randomIndex, 1);
            calledStudents.push(selectedStudent);
            localStorage.setItem('calledStudents', JSON.stringify(calledStudents));
            
            showCallResult(selectedStudent);
            renderSeatMap();
        }

        // æ˜¾ç¤ºç‚¹åç»“æœ
        function showCallResult(student) {
            const calledStudentElement = document.getElementById('calledStudent');
            const pronunciationHint = document.getElementById('pronunciationHint');
            
            calledStudentElement.textContent = student;
            
            if (student.includes('è¦ƒ')) {
                pronunciationHint.style.display = 'block';
            } else {
                pronunciationHint.style.display = 'none';
            }
            
            document.getElementById('callModal').style.display = 'block';
            speakStudentName(student);
        }

        // å…³é—­ç‚¹åå¼¹çª—
        function closeCallModal() {
            document.getElementById('callModal').style.display = 'none';
        }

        // è¯­éŸ³æœ—è¯»å­¦ç”Ÿå§“å
        function speakStudentName(name) {
            const correctedName = name.replace(/è¦ƒ/g, 'qÃ­n');
            
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(correctedName);
                utterance.lang = 'zh-CN';
                speechSynthesis.speak(utterance);
            }
        }

        // é‡ç½®ç‚¹åç³»ç»Ÿ
        function resetCallSystem() {
            calledStudents = [];
            availableStudents = [...students];
            localStorage.setItem('calledStudents', JSON.stringify(calledStudents));
        }

        function downloadFile(filename, content) {
            const blob = new Blob([content], {type: 'text/csv;charset=UTF-8'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // åˆå§‹åŒ–äº‹ä»¶
        document.getElementById('violationType').addEventListener('change', function() {
            document.getElementById('customViolation').style.display = 
                this.value === 'å…¶ä»–' ? 'inline-block' : 'none';
        });
        
        document.getElementById('praiseType').addEventListener('change', function() {
            document.getElementById('customPraise').style.display = 
                this.value === 'å…¶ä»–å¥½è¡Œä¸º' ? 'inline-block' : 'none';
        });
        
        document.querySelectorAll('input[name="recordType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'violation') {
                    document.getElementById('violationSection').style.display = 'block';
                    document.getElementById('praiseSection').style.display = 'none';
                } else {
                    document.getElementById('violationSection').style.display = 'none';
                    document.getElementById('praiseSection').style.display = 'block';
                }
            });
        });

        // å¯åŠ¨ç³»ç»Ÿ
        function createStars() {
            const container = document.getElementById('starContainer');
            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = Math.random() * 3 + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(star);
            }
        }

        createStars();
        availableStudents = [...students];
        if (students.length > 0) {
            initializeSeatMap();
        }
    </script>
</body>
</html>